#!/bin/sh

# $TSUKUBA_Release: Omni OpenMP Compiler 3 $
# $TSUKUBA_Copyright:
#  PLEASE DESCRIBE LICENSE AGREEMENT HERE
#  $
OUTFILE=$1
INPFILE=$2

if [ -z "${OUTFILE}" ]; then
    echo output file not specified
    exit 1
fi

if [ -z "${INPFILE}" ]; then
    echo input file not specified
    exit 1
fi

#--- decode space characters, corresponding to the modification of omdriver.c
#--- (ID=278)
OM_OPTION_ARR=()
for opt in ${OM_OPTIONS}; do
    opt1=$(echo $opt | sed 's/\\s/ /g
                            s/\\t/\t/g
                            s/\\\\/\\/g')
    OM_OPTION_ARR=( "${OM_OPTION_ARR[@]}" "$opt1" )
done

if [ ! -z "${OM_TRANSLATORS}" ]; then
    OM_OPTIONS="${OM_OPTIONS} -I${OMNI_HOME}/include"
    for TID in ${OM_TRANSLATORS}; do
	CONF="${OM_DRIVER_CONF_DIR}/pp.conf.${TID}"
        if [ -r ${CONF} ]; then
            . ${CONF}
        else
            echo cannot read ${CONF} script.
            exit 1
        fi
    done;
fi

GASNET_CPPFLAGS="@GASNET_CPPFLAGS@"
CMD=${PP}
OPTION_ARR=( "${OM_OPTION_ARR[@]}" ${GASNET_CPPFLAGS} ${INPFILE} )

set -- "${OPTION_ARR[@]}"

if [ "${OM_VERBOSE}" = "1" ]; then
    echo $CMD "$@" \> ${OUTFILE}
fi

$CMD "$@" > ${OUTFILE} || exit $?
