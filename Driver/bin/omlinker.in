#!/bin/sh

# $TSUKUBA_Release: Omni OpenMP Compiler 3 $
# $TSUKUBA_Copyright:
#  PLEASE DESCRIBE LICENSE AGREEMENT HERE
#  $
OUTFILE=$1
shift
INPFILES=$@

if [ -z "${OUTFILE}" ]; then
    echo output file not specified
    exit 1
fi

if [ ! -z "${OM_TRANSLATORS}" ]; then
    for TID in ${OM_TRANSLATORS}; do
        CONF="${OMNI_HOME}/etc/linker.conf.${TID}"
        if [ -r ${CONF} ]; then
            . ${CONF}
        else
            echo cannot read ${CONF} script.
            exit 1
        fi
    done;
fi

newOpts=''
for i in ${OM_OPTIONS}; do
    case ${i} in
        -enable-gpu)
            if ls *.xmpgpu.o >/dev/null 2>&1; then
                INPFILES="${INPFILES} *.xmpgpu.o"
            fi;;
        *)
            newOpts="${newOpts} ${i}";;
    esac
done
OM_OPTIONS="${newOpts}"

GASNET_PREFIX="@GASNET_PREFIX@"
GASNET_CONDUIT="@GASNET_CONDUIT@"
CMD=""
if test "${GASNET_PREFIX}" != "" -a "${GASNET_CONDUIT}" != "" ; then
  GASNET_OPTIONS="@GASNET_LDFLAGS@ @GASNET_LIBS@"
  CMD="${LINKER} ${OM_OPTIONS} ${INPFILES} ${LIBS} ${GASNET_OPTIONS}"
else
  CMD="${LINKER} ${OM_OPTIONS} ${INPFILES} ${LIBS}"
fi

if [ "${OM_VERBOSE}" = "1" ]; then
    echo $CMD
fi

$CMD || exit $?
